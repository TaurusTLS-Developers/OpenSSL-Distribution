name: Build OpenSSL 3.x Multi-Platform
run-name: Build OpenSSL ${{ inputs.version }}

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenSSL Version (e.g. 3.4.0)'
        required: true
        default: '3.4.0'

jobs:
  build:
    name: ${{ matrix.os-label }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os-runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- WINDOWS (MSVC / UCRT / Win10) ---
          - os-label: Windows
            os-runner: windows-latest
            arch: x64
            target: VC-WIN64A
            vcvars: x64
          - os-label: Windows
            os-runner: windows-latest
            arch: x86
            target: VC-WIN32
            vcvars: x86
          - os-label: Windows
            os-runner: windows-11-arm
            arch: arm64ec
            target: VC-WIN64-ARM
            vcvars: arm64
            no_asm: true

          # --- LINUX ---
          - os-label: Linux
            os-runner: ubuntu-latest
            arch: x64
            target: linux-x86_64
          - os-label: Linux
            os-runner: ubuntu-latest
            arch: arm64
            target: linux-aarch64
            cross_prefix: aarch64-linux-gnu-

          # --- MACOS ---
          - os-label: macOS
            os-runner: macos-14
            arch: x64
            target: darwin64-x86_64-cc
          - os-label: macOS
            os-runner: macos-14
            arch: arm64
            target: darwin64-arm64-cc

          # --- ANDROID ---
          - os-label: Android
            os-runner: ubuntu-latest
            arch: arm64
            target: android-arm64
          - os-label: Android
            os-runner: ubuntu-latest
            arch: x86_64
            target: android-x86_64

          # --- IOS (Static Only) ---
          - os-label: iOS
            os-runner: macos-14
            arch: arm64
            target: ios64-cross
            static_only: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential perl zip libsctp-dev
          if [ "${{ matrix.arch }}" == "arm64" ]; then sudo apt-get install -y gcc-aarch64-linux-gnu; fi

      - name: Download OpenSSL Source
        shell: bash
        run: |
          curl -L -o openssl.tar.gz https://github.com/openssl/openssl/releases/download/openssl-${{ github.event.inputs.version }}/openssl-${{ github.event.inputs.version }}.tar.gz
          tar -xzf openssl.tar.gz
          mv openssl-${{ github.event.inputs.version }} src

      - name: Patch Android 16K Page Alignment
        if: matrix.os-label == 'Android'
        shell: bash
        working-directory: src
        run: |
          sed -i 's/cppflags         => "-D__ANDROID_API__=$(ANDROID_API)"/cppflags => "-D__ANDROID_API__=$(ANDROID_API) -fPIC",\n        lflags => "-Wl,-z,max-page-size=16384"/' Configurations/15-android.conf

      - name: Setup Windows Linker
        if: runner.os == 'Windows'
        shell: bash
        run: rm -f /usr/bin/link.exe 2>/dev/null || true

      # ------------------------------------------------------------------------
      # SHARED BUILD
      # ------------------------------------------------------------------------
      - name: Build Shared (Windows)
        if: runner.os == 'Windows' && matrix.static_only != true
        shell: cmd
        working-directory: src
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" ${{ matrix.vcvars }}
          if "${{ matrix.arch }}"=="arm64ec" (
            set "CFLAGS=/nologo /arm64EC /O1 /D_WIN32_WINNT=0x0A00"
            set "LFLAGS=/MACHINE:ARM64EC"
            set "OPTS=no-asm"
          ) else (
            set "CFLAGS=/nologo /O2 /D_WIN32_WINNT=0x0A00"
            set "LFLAGS="
            set "OPTS="
          )
          perl Configure ${{ matrix.target }} --prefix=%GITHUB_WORKSPACE%\dist\shared shared no-tests %OPTS% "CFLAGS=%CFLAGS%" "LDFLAGS=%LFLAGS%" "ARFLAGS=%LFLAGS%"
          nmake && nmake install_sw && nmake install_html_docs

      - name: Build Shared (Unix/Android)
        if: runner.os != 'Windows' && matrix.static_only != true
        working-directory: src
        run: |
          EXTRA_FLAGS=""
          if [ "${{ matrix.os-label }}" == "Android" ]; then
            export ANDROID_NDK_ROOT=$ANDROID_NDK_LATEST_HOME
            export PATH=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
            export ANDROID_API=28
          elif [ "${{ matrix.os-label }}" == "Linux" ]; then
            EXTRA_FLAGS="enable-sctp -Wl,-rpath,'\$ORIGIN'"
            [ "${{ matrix.arch }}" == "arm64" ] && export CROSS_COMPILE=${{ matrix.cross_prefix }}
          fi
          ./Configure ${{ matrix.target }} --prefix=/usr/local shared no-tests $EXTRA_FLAGS
          make -j$(nproc)
          mkdir -p ../_staging
          make install_sw DESTDIR=${{ github.workspace }}/_staging
          make install_html_docs DESTDIR=${{ github.workspace }}/_staging || true
          mkdir -p ../dist/shared && cp -r ../_staging/usr/local/* ../dist/shared/

      # ------------------------------------------------------------------------
      # STATIC BUILD
      # ------------------------------------------------------------------------
      - name: Build Static (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        working-directory: src
        run: |
          if exist Makefile nmake clean
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" ${{ matrix.vcvars }}
          if "${{ matrix.arch }}"=="arm64ec" (
            set "CFLAGS=/nologo /arm64EC /O1 /D_WIN32_WINNT=0x0A00"
            set "LFLAGS=/MACHINE:ARM64EC"
            set "OPTS=no-asm"
          ) else (
            set "CFLAGS=/nologo /O2 /D_WIN32_WINNT=0x0A00"
            set "LFLAGS="
            set "OPTS="
          )
          perl Configure ${{ matrix.target }} --prefix=%GITHUB_WORKSPACE%\dist\static no-shared no-tests %OPTS% "CFLAGS=%CFLAGS%" "LDFLAGS=%LFLAGS%" "ARFLAGS=%LFLAGS%"
          nmake && nmake install_sw

      - name: Build Static (Unix/Android/iOS)
        if: runner.os != 'Windows'
        working-directory: src
        run: |
          [ -f Makefile ] && make clean || echo "No Makefile"
          EXTRA_FLAGS=""
          if [ "${{ matrix.os-label }}" == "Android" ]; then
            export ANDROID_NDK_ROOT=$ANDROID_NDK_LATEST_HOME
            export PATH=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
            export ANDROID_API=28
          elif [ "${{ matrix.os-label }}" == "Linux" ]; then
            EXTRA_FLAGS="enable-sctp"
            [ "${{ matrix.arch }}" == "arm64" ] && export CROSS_COMPILE=${{ matrix.cross_prefix }}
          elif [ "${{ matrix.os-label }}" == "iOS" ]; then
            export CROSS_TOP=$(xcode-select -p)/Platforms/iPhoneOS.platform/Developer
            export CROSS_SDK=iPhoneOS.sdk
          fi
          ./Configure ${{ matrix.target }} --prefix=/usr/local no-shared no-tests $EXTRA_FLAGS
          make -j$(nproc)
          mkdir -p ../_staging_static
          make install_sw DESTDIR=${{ github.workspace }}/_staging_static
          mkdir -p ../dist/static && cp -r ../_staging_static/usr/local/* ../dist/static/

      # ------------------------------------------------------------------------
      # PACKAGING
      # ------------------------------------------------------------------------
      - name: Organize Artifacts
        shell: bash
        run: |
          mkdir -p pkg/engines pkg/providers pkg/lib pkg/doc pkg/include
          cp src/LICENSE.txt pkg/

          # 1. Shared Libraries & Binary (Root + Modules)
          if [ "${{ matrix.static_only }}" != "true" ] && [ -d "dist/shared" ]; then
            if [ "${{ runner.os }}" == "Windows" ]; then
              cp dist/shared/bin/*.dll pkg/
              cp dist/shared/bin/*.exe pkg/
              find dist/shared/lib -name "*.dll" | grep "ossl-modules" | xargs -I {} cp {} pkg/providers/
              find dist/shared/lib -name "*.dll" | grep "engines-3" | xargs -I {} cp {} pkg/engines/
            else
              LIBDIR="dist/shared/lib"; [ -d "dist/shared/lib64" ] && LIBDIR="dist/shared/lib64"
              # Preserve symlinks for shared libs in the package
              cp -RP $LIBDIR/*.so* pkg/ 2>/dev/null || true
              cp -RP $LIBDIR/*.dylib* pkg/ 2>/dev/null || true
              [ -f dist/shared/bin/openssl ] && cp dist/shared/bin/openssl pkg/
              find $LIBDIR -path "*/ossl-modules/*.so*" -exec cp -RP {} pkg/providers/ \; 2>/dev/null || true
              find $LIBDIR -path "*/ossl-modules/*.dylib*" -exec cp -RP {} pkg/providers/ \; 2>/dev/null || true
              find $LIBDIR -path "*/engines-3/*.so*" -exec cp -RP {} pkg/engines/ \; 2>/dev/null || true
              find $LIBDIR -path "*/engines-3/*.dylib*" -exec cp -RP {} pkg/engines/ \; 2>/dev/null || true
            fi
          fi

          # 2. Static Libraries (Stripped)
          if [ "${{ runner.os }}" == "Windows" ]; then
             cp dist/static/lib/*.lib pkg/lib/
             # llvm-strip is available on windows-latest to strip .lib files
             find pkg/lib -name "*.lib" -exec llvm-strip --strip-debug {} \;
          else
             SLIBDIR="dist/static/lib"; [ -d "dist/static/lib64" ] && SLIBDIR="dist/static/lib64"
             cp $SLIBDIR/*.a pkg/lib/ 2>/dev/null || true
             # Standard strip for .a files
             STRIP_CMD="strip"; [ "${{ matrix.arch }}" == "arm64" ] && [ "${{ runner.os }}" == "Linux" ] && STRIP_CMD="${{ matrix.cross_prefix }}strip"
             find pkg/lib -name "*.a" -exec $STRIP_CMD --strip-debug {} \;
          fi

          # 3. Headers & Docs
          cp -r dist/static/include/* pkg/include/
          [ -d "dist/shared/html" ] && cp -r dist/shared/html/* pkg/doc/ || true
          [ -d "dist/static/html" ] && cp -r dist/static/html/* pkg/doc/ || true
          [ -d "dist/shared/share/doc/openssl/html" ] && cp -r dist/shared/share/doc/openssl/html/* pkg/doc/ || true

          # 4. Cleanup empty folders
          for i in {1..3}; do find pkg -type d -empty -delete 2>/dev/null; done

      # ------------------------------------------------------------------------
      # FINAL PACKING
      # ------------------------------------------------------------------------
      - name: Create Final Archive
        shell: bash
        run: |
          BASE_NAME="openssl-${{ github.event.inputs.version }}-${{ matrix.os-label }}-${{ matrix.arch }}"
          if [ ! -d "pkg" ] || [ -z "$(ls -A "pkg")" ]; then exit 0; fi
          
          if [ "${{ runner.os }}" == "Windows" ]; then
            (cd pkg && 7z a -tzip "../${BASE_NAME}.zip" .)
          else
            # tar.gz for POSIX to preserve symlinks and permissions
            (cd pkg && tar -czvf "../${BASE_NAME}.tar.gz" .)
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openssl-${{ matrix.os-label }}-${{ matrix.arch }}
          path: |
             openssl-*.zip
             openssl-*.tar.gz
name: Build OpenSSL 3.x

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenSSL Version (e.g. 3.3.0)'
        required: true
        default: '3.3.0'

jobs:
  build:
    name: ${{ matrix.os-label }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os-runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows 64-bit
          - os-label: Windows
            os-runner: windows-latest
            arch: x64
            target: VC-WIN64A
            setup_cmd: call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          
          # Windows 32-bit
          - os-label: Windows
            os-runner: windows-latest
            arch: x86
            target: VC-WIN32
            setup_cmd: call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars32.bat"

          # Linux x64
          - os-label: Linux
            os-runner: ubuntu-latest
            arch: x64
            target: linux-x86_64
            setup_cmd: sudo apt-get update && sudo apt-get install -y build-essential

          # macOS x64 (Intel) - Cross-compile on ARM runner
          - os-label: macOS
            os-runner: macos-14
            arch: x64
            target: darwin64-x86_64-cc
            setup_cmd: echo "Setup Mac Intel"

          # macOS ARM64 (Apple Silicon)
          - os-label: macOS
            os-runner: macos-14
            arch: arm64
            target: darwin64-arm64-cc
            setup_cmd: echo "Setup Mac ARM"

    steps:
      - name: Checkout Builder Repo
        uses: actions/checkout@v4

      - name: Install Perl/NASM (Windows Only)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install NASM (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/setup-nasm@v1
        with:
          # This tells VS to setup x64 or x86 based on your matrix value
          arch: ${{ matrix.arch }}

      - name: Remove GNU Link (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
                if exist "C:\Program Files\Git\usr\bin\link.exe" del "C:\Program Files\Git\usr\bin\link.exe"        

      - name: Download OpenSSL Source
        run: |
          curl -L -o openssl.tar.gz https://github.com/openssl/openssl/releases/download/openssl-${{ github.event.inputs.version }}/openssl-${{ github.event.inputs.version }}.tar.gz
          tar -xzf openssl.tar.gz
          mv openssl-${{ github.event.inputs.version }} src

      # ------------------------------------------------------------------------
      # CONFIGURE & BUILD SHARED
      # ------------------------------------------------------------------------
      
      # WINDOWS: Use /MT for static CRT linking
      - name: Configure Shared (Windows)
        if: runner.os == 'Windows'
        working-directory: src
        run: |
          perl Configure ${{ matrix.target }} --prefix=${{ github.workspace }}/dist/shared shared no-tests "CFLAGS=/nologo /O2 /MT"

      # UNIX: Standard build (NO /MT flag)
      - name: Configure Shared (Unix)
        if: runner.os != 'Windows'
        working-directory: src
        run: |
          ./Configure ${{ matrix.target }} --prefix=${{ github.workspace }}/dist/shared shared no-tests

      - name: Build Shared
        working-directory: src
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            nmake
            nmake install
          else
            make -j4
            make install_sw
          fi
        shell: bash

      # ------------------------------------------------------------------------
      # CLEAN
      # ------------------------------------------------------------------------

      - name: Clean Source (Windows)
        if: runner.os == 'Windows'
        working-directory: src
        shell: cmd
        run: nmake clean

      - name: Clean Source (Unix)
        if: runner.os != 'Windows'
        working-directory: src
        shell: bash
        run: make clean

      # ------------------------------------------------------------------------
      # CONFIGURE & BUILD STATIC
      # ------------------------------------------------------------------------

      # WINDOWS: Use /MT
      - name: Configure Static (Windows)
        if: runner.os == 'Windows'
        working-directory: src
        run: |
          perl Configure ${{ matrix.target }} --prefix=${{ github.workspace }}/dist/static no-shared no-tests "CFLAGS=/nologo /O2 /MT"

      # UNIX: Standard build (NO /MT flag)
      - name: Configure Static (Unix)
        if: runner.os != 'Windows'
        working-directory: src
        run: |
          ./Configure ${{ matrix.target }} --prefix=${{ github.workspace }}/dist/static no-shared no-tests

      - name: Build Static
        working-directory: src
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            nmake
            nmake install
          else
            make -j4
            make install_sw
          fi
        shell: bash
        
      # ------------------------------------------------------------------------
      # PACKAGING
      # ------------------------------------------------------------------------
      - name: Zip Artifacts
        working-directory: dist
        run: |
          7z a ../openssl-${{ github.event.inputs.version }}-${{ matrix.os-label }}-${{ matrix.arch }}.zip .
        shell: bash

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openssl-${{ matrix.os-label }}-${{ matrix.arch }}
          path: openssl-*.zip
